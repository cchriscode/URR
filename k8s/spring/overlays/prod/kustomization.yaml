# ─── Production Monitoring ─────────────────────────────────────────
# Deploy kube-prometheus-stack via Helm:
#   helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
#   helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack \
#     --namespace monitoring --create-namespace \
#     -f k8s/spring/overlays/prod/monitoring-values.yaml
# ────────────────────────────────────────────────────────────────────
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: urr-spring

resources:
  - ../../base
  - pdb.yaml
  - hpa.yaml
  # kafka.yaml / redis.yaml removed: production uses AWS MSK + ElastiCache
  - zipkin.yaml
  - analysis-template.yaml
  - preview-services.yaml
  - rollouts/gateway-service.yaml
  - rollouts/ticket-service.yaml
  - rollouts/payment-service.yaml
  - rollouts/queue-service.yaml
  - network-policy-egress.yaml
  - init-databases.yaml

configMapGenerator:
  - name: spring-prod-config
    envs:
      - config.env

# secretGenerator removed: secrets.env is gitignored and unavailable to ArgoCD.
# Create secret manually: kubectl create secret generic spring-prod-secret \
#   --from-env-file=secrets.env -n urr-spring --dry-run=client -o yaml | kubectl apply -f -

generatorOptions:
  disableNameSuffixHash: true

patches:
  - path: patches/replicas.yaml
  - path: patches/services-env.yaml

# CI/CD replaces ECR_REGISTRY via: sed -i "s|CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com|${ECR_REGISTRY}|g" kustomization.yaml
images:
  - name: YOUR_ECR_URI/gateway-service
    newName: CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com/urr/gateway
    newTag: latest
  - name: YOUR_ECR_URI/auth-service
    newName: CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com/urr/auth
    newTag: latest
  - name: YOUR_ECR_URI/ticket-service
    newName: CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com/urr/ticket
    newTag: latest
  - name: YOUR_ECR_URI/payment-service
    newName: CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com/urr/payment
    newTag: latest
  - name: YOUR_ECR_URI/stats-service
    newName: CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com/urr/stats
    newTag: latest
  - name: YOUR_ECR_URI/queue-service
    newName: CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com/urr/queue
    newTag: latest
  - name: YOUR_ECR_URI/catalog-service
    newName: CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com/urr/catalog
    newTag: latest
  - name: YOUR_ECR_URI/community-service
    newName: CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com/urr/community
    newTag: latest
  - name: YOUR_ECR_URI/frontend
    newName: CHANGE_ME.dkr.ecr.ap-northeast-2.amazonaws.com/urr/frontend
    newTag: latest
