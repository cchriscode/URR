# URR 프론트엔드 종합 분석 문서

> 분석 대상: `apps/web/` (Next.js 프론트엔드 애플리케이션)
> 분석 일자: 2026-02-17

---

## 1. 기술 스택

### 1.1 핵심 프레임워크 및 언어

| 기술 | 버전 | 출처 |
|------|------|------|
| Next.js | 16.1.6 | `apps/web/package.json:18` |
| React | 19.2.3 | `apps/web/package.json:19` |
| React DOM | 19.2.3 | `apps/web/package.json:20` |
| TypeScript | 5.9.3 | `apps/web/package.json:37` |
| Tailwind CSS | v4 | `apps/web/package.json:35` |

### 1.2 주요 의존성 (dependencies)

| 패키지 | 버전 | 용도 |
|--------|------|------|
| `@tanstack/react-query` | ^5.90.21 | 서버 상태 관리 및 데이터 페칭 (`apps/web/package.json:15`) |
| `@tosspayments/payment-sdk` | ^1.9.2 | 토스페이먼츠 결제 연동 (`apps/web/package.json:16`) |
| `axios` | ^1.13.5 | HTTP 클라이언트 (`apps/web/package.json:17`) |
| `recharts` | ^3.7.0 | 통계 차트 시각화 (`apps/web/package.json:21`) |

### 1.3 개발 의존성 (devDependencies)

| 패키지 | 버전 | 용도 |
|--------|------|------|
| `@playwright/test` | ^1.58.2 | E2E 테스트 (`apps/web/package.json:24`) |
| `@tailwindcss/postcss` | ^4 | Tailwind CSS PostCSS 플러그인 (`apps/web/package.json:25`) |
| `@testing-library/jest-dom` | ^6.9.1 | DOM 테스트 매처 (`apps/web/package.json:26`) |
| `@testing-library/react` | ^16.3.2 | React 컴포넌트 테스트 (`apps/web/package.json:27`) |
| `@vitejs/plugin-react` | ^4.7.0 | Vite React 플러그인 (`apps/web/package.json:31`) |
| `happy-dom` | ^20.6.1 | 테스트용 DOM 환경 (`apps/web/package.json:34`) |
| `vitest` | ^4.0.18 | 유닛 테스트 러너 (`apps/web/package.json:37`) |
| `eslint-config-next` | 16.1.6 | Next.js ESLint 설정 (`apps/web/package.json:33`) |

### 1.4 빌드/배포 설정

**스크립트** (`apps/web/package.json:5-13`):

```json
"dev": "next dev",
"build": "next build",
"start": "next start",
"lint": "eslint",
"test": "vitest run",
"test:watch": "vitest",
"test:e2e": "playwright test"
```

**TypeScript 설정** (`apps/web/tsconfig.json:1-34`):
- 타겟: ES2017
- 모듈: ESNext (bundler resolution)
- strict 모드 활성화
- 경로 별칭: `@/*` -> `./src/*` (라인 22)
- JSX: react-jsx
- incremental 빌드 활성화

**PostCSS** (`apps/web/postcss.config.mjs:1-7`): `@tailwindcss/postcss` 플러그인 사용

**ESLint** (`apps/web/eslint.config.mjs:1-18`): `eslint-config-next/core-web-vitals` + `eslint-config-next/typescript` 조합

---

## 2. 프로젝트 구조

### 2.1 디렉토리 구조

```
apps/web/src/
  app/                          # Next.js App Router 페이지
    admin/                      # 관리자 대시보드
      events/                   #   이벤트 CRUD
        edit/[id]/page.tsx      #   이벤트 수정
        new/page.tsx            #   이벤트 생성
        page.tsx                #   이벤트 목록
      reservations/page.tsx     #   예매 관리
      statistics/               #   통계 대시보드
        page.tsx
        StatisticsCharts.tsx    #   차트 컴포넌트 (dynamic import)
      error.tsx                 #   관리자 에러 바운더리
      loading.tsx               #   관리자 로딩 UI
      page.tsx                  #   관리자 메인 대시보드
    artists/                    # 아티스트
      [id]/page.tsx             #   아티스트 상세 (멤버십 포함)
      page.tsx                  #   아티스트 목록 (SSR)
      page-client.tsx           #   아티스트 클라이언트 컴포넌트
    community/                  # 커뮤니티 게시판
      [postId]/                 #   게시글 상세
        edit/page.tsx           #   게시글 수정
        page.tsx                #   게시글 상세
      write/page.tsx            #   게시글 작성
      error.tsx
      loading.tsx
      page.tsx                  #   게시글 목록
    events/                     # 이벤트/공연
      [id]/
        book/page.tsx           #   스탠딩 예매 (티켓 선택)
        seats/page.tsx          #   좌석 선택 예매
        event-detail-client.tsx #   이벤트 상세 클라이언트
        page.tsx                #   이벤트 상세 (SSR)
        page-client.tsx         #   이벤트 상세 클라이언트 래퍼
        loading.tsx
      error.tsx
      loading.tsx
    login/page.tsx              # 로그인
    register/page.tsx           # 회원가입
    membership-payment/
      [membershipId]/page.tsx   # 멤버십 결제
    my-memberships/page.tsx     # 내 멤버십 목록
    my-reservations/            # 내 예매 목록
      page.tsx
      loading.tsx
    news/                       # 공지사항
      [id]/
        edit/page.tsx           #   공지 수정
        page.tsx                #   공지 상세
      create/page.tsx           #   공지 작성
      page.tsx                  #   공지 목록
    payment/                    # 결제
      [reservationId]/page.tsx  #   결제 페이지
      success/page.tsx          #   결제 성공 (Toss 콜백)
      fail/page.tsx             #   결제 실패 (Toss 콜백)
    payment-success/
      [reservationId]/page.tsx  # 결제 성공 (레거시)
    queue/
      [eventId]/page.tsx        # 대기열 페이지
    reservations/
      [id]/page.tsx             # 예매 상세
    search/page.tsx             # 검색 결과
    transfer-payment/
      [transferId]/page.tsx     # 양도 구매 결제
    transfers/                  # 양도 마켓
      my/page.tsx               #   내 양도 목록
      page.tsx                  #   양도 마켓 메인
    error.tsx                   # 글로벌 에러 바운더리
    globals.css                 # 글로벌 스타일
    layout.tsx                  # 루트 레이아웃
    loading.tsx                 # 글로벌 로딩 (스켈레톤)
    not-found.tsx               # 404 페이지
    page.tsx                    # 홈페이지 (SSR)
    page-client.tsx             # 홈페이지 클라이언트
    providers.tsx               # QueryClient + AuthProvider
  components/                   # 공용 컴포넌트
    auth-guard.tsx              #   인증 가드
    page-card.tsx               #   페이지 카드 래퍼
    site-header.tsx             #   사이트 헤더/네비게이션
    vwr-modal.tsx               #   VWR 대기열 모달
    ui/
      Spinner.tsx               #   로딩 스피너
      StatusBadge.tsx           #   상태 배지
  hooks/                        # 커스텀 훅
    use-countdown.ts            #   카운트다운 타이머
    use-events.ts               #   이벤트 데이터 (React Query)
    use-queue-polling.ts        #   큐 폴링
    use-reservations.ts         #   예매 데이터 (React Query)
    use-server-time.ts          #   서버 시간 동기화
    use-vwr-polling.ts          #   VWR 대기열 폴링
  lib/                          # 유틸리티 및 API
    api-client.ts               #   Axios/Fetch API 클라이언트
    auth-context.tsx            #   인증 컨텍스트
    format.ts                   #   날짜/가격 포맷
    server-api.ts               #   서버 컴포넌트 전용 fetch
    storage.ts                  #   로컬 스토리지 헬퍼
    types.ts                    #   TypeScript 타입 정의
  middleware.ts                 # CSP 및 보안 헤더
  test/                         # 테스트 파일
    components/
    hooks/
    lib/
    setup.tsx
```

### 2.2 라우팅 구조 (App Router)

Next.js App Router를 사용하며, 모든 페이지는 `src/app/` 하위에 디렉토리 기반으로 구성된다.

**공개 라우트** (비로그인 접근 가능):
- `/` - 홈 (이벤트 목록)
- `/login` - 로그인
- `/register` - 회원가입
- `/events/[id]` - 이벤트 상세
- `/artists` - 아티스트 목록
- `/artists/[id]` - 아티스트 상세
- `/community` - 커뮤니티
- `/community/[postId]` - 게시글 상세
- `/news` - 공지사항
- `/news/[id]` - 공지 상세
- `/search` - 검색 결과

**인증 필요 라우트** (`AuthGuard` 사용):
- `/events/[id]/book` - 스탠딩 예매
- `/events/[id]/seats` - 좌석 선택
- `/queue/[eventId]` - 대기열
- `/my-reservations` - 내 예매
- `/reservations/[id]` - 예매 상세
- `/payment/[reservationId]` - 결제
- `/my-memberships` - 내 멤버십
- `/membership-payment/[membershipId]` - 멤버십 결제
- `/transfers` - 양도 마켓
- `/transfers/my` - 내 양도 목록
- `/transfer-payment/[transferId]` - 양도 구매 결제
- `/community/write` - 글쓰기
- `/community/[postId]/edit` - 글 수정

**관리자 전용 라우트** (`AuthGuard adminOnly` 사용):
- `/admin` - 관리자 대시보드
- `/admin/events` - 이벤트 관리
- `/admin/events/new` - 이벤트 생성
- `/admin/events/edit/[id]` - 이벤트 수정
- `/admin/reservations` - 예매 관리
- `/admin/statistics` - 통계 대시보드

### 2.3 컴포넌트 구성 패턴

**서버/클라이언트 분리 (SSR Hydration 패턴)**:
홈, 이벤트 상세, 아티스트 목록 페이지는 서버 컴포넌트(`page.tsx`)에서 데이터를 `fetch`한 뒤 클라이언트 컴포넌트(`page-client.tsx`)에 `initialData`로 전달하는 패턴을 사용한다.

- `src/app/page.tsx:3-14` -> `src/app/page-client.tsx` (홈)
- `src/app/events/[id]/page.tsx:3-14` -> `src/app/events/[id]/page-client.tsx` (이벤트 상세)
- `src/app/artists/page.tsx:3-14` -> `src/app/artists/page-client.tsx` (아티스트 목록)

서버 컴포넌트에서는 `INTERNAL_API_URL` 환경변수(기본값 `http://gateway-service:3001`)를 사용해 클러스터 내부 API를 직접 호출하고, 클라이언트 컴포넌트에서는 React Query를 통해 `NEXT_PUBLIC_API_URL`로 브라우저 요청을 보낸다.

---

## 3. 페이지별 상세 분석

### 3.1 홈페이지 (`/`)

**파일**: `src/app/page.tsx:1-19` (서버), `src/app/page-client.tsx:1-184` (클라이언트)

**기능**: 이벤트 목록을 그리드로 표시. 상태 필터(예매 중/오픈 예정/종료/취소/전체) 지원.

**컴포넌트**:
- `HomePageClient` (`page-client.tsx:120`) - 메인 클라이언트 컴포넌트
- `EventCard` (`page-client.tsx:45-114`) - 개별 이벤트 카드 (포스터, 카운트다운, 가격, 아티스트)

**API 호출**:
- SSR: `fetch('/api/v1/events?status=on_sale&page=1&limit=12')` (`page.tsx:5-6`)
- CSR: `useEvents(params)` -> `eventsApi.list(params)` (`page-client.tsx:126`)

**상태 관리**:
- `useState` - `filter` (상태 필터) (`page-client.tsx:121`)
- `useEvents` (React Query) - 이벤트 데이터 (`page-client.tsx:126`)
- `useCountdown` - 각 이벤트 카드의 카운트다운 (`page-client.tsx:54`)

**핵심 경로**: `src/app/page.tsx`, `src/app/page-client.tsx`

### 3.2 로그인 (`/login`)

**파일**: `src/app/login/page.tsx:1-156`

**기능**: 이메일/비밀번호 로그인 + Google OAuth 소셜 로그인.

**컴포넌트**: `LoginPage` (라인 11)

**API 호출**:
- `authApi.login({ email, password })` (라인 24)
- `authApi.google(credential)` (라인 82)

**상태 관리**:
- `useState` - `email`, `password`, `error`, `loading` (라인 14-17)
- `useAuth().refresh` - 로그인 성공 후 사용자 정보 갱신 (라인 13, 25)

**Google OAuth 처리** (라인 41-76):
- `NEXT_PUBLIC_GOOGLE_CLIENT_ID` 환경변수로 클라이언트 ID 주입 (라인 9)
- `<script src="https://accounts.google.com/gsi/client">` 동적 로드 (라인 44-45)
- `google.accounts.id.initialize()` + `renderButton()` 호출 (라인 56-69)
- 콜백에서 `authApi.google(response.credential)` 호출 (라인 82)

### 3.3 회원가입 (`/register`)

**파일**: `src/app/register/page.tsx:1-111`

**기능**: 이름/이메일/비밀번호/전화번호 입력 회원가입.

**API 호출**: `authApi.register(form)` (라인 21)

**상태 관리**: `useState` - form 객체(email, password, name, phone), error, loading (라인 12-14)

**에러 처리**: 409(이미 등록), 400(입력 오류) 등 상태 코드별 한국어 메시지 분기 (라인 28-34)

### 3.4 이벤트 상세 (`/events/[id]`)

**파일**: `src/app/events/[id]/page.tsx:1-20` (SSR), `src/app/events/[id]/page-client.tsx:1-36`, `src/app/events/[id]/event-detail-client.tsx:1-167`

**기능**: 이벤트 상세 정보(포스터, 장소, 일시, 판매기간, 티켓 종류) 표시. "예매하기" 버튼 클릭 시 VWR 대기열 모달 오픈.

**컴포넌트**:
- `EventDetailClient` (`event-detail-client.tsx:28`)
- `VwrModal` (`event-detail-client.tsx:149`)

**API 호출**:
- SSR: `fetch('/api/v1/events/${id}')` (`page.tsx:5`)
- CSR: `useEventDetail(params.id)` (`page-client.tsx:16`)

**상태 관리**:
- `useState` - `vwrOpen` (VWR 모달 열림 여부) (`event-detail-client.tsx:30`)
- `useCountdown` - 판매 시작/종료 카운트다운 (`event-detail-client.tsx:49`)

**핵심 로직**: 예매 버튼 클릭 시 VWR 모달을 열고, 입장 허가(admitted) 시 `/queue/[eventId]`로 이동 (`event-detail-client.tsx:153-156`)

### 3.5 대기열 (`/queue/[eventId]`)

**파일**: `src/app/queue/[eventId]/page.tsx:1-219`

**기능**: 서버 기반 큐 대기열. 순번/내 앞/내 뒤/예상 대기시간 표시. 순서가 되면 자동으로 좌석 선택 또는 티켓 선택 페이지로 리다이렉트.

**컴포넌트**: `QueuePage` (라인 19)

**API 호출**:
- `queueApi.check(eventId, vwrPos)` - 큐 진입 (라인 93)
- `queueApi.status(eventId)` - 폴링 (via `useQueuePolling`)
- `eventsApi.detail(eventId)` - 좌석 레이아웃 존재 여부 확인 (라인 59-61)
- `queueApi.leave(eventId)` - 대기열 이탈 (라인 208)
- `navigator.sendBeacon(...)` - 페이지 이탈 시 leave 호출 (라인 50)

**상태 관리**:
- `useState` - `joined`, `vwrPosition`, `seatLayoutId`, `checkResult` (라인 23-74)
- `useQueuePolling(eventId, joined)` - 폴링 활성화 조건부 (라인 111)

**VWR 토큰 브릿지** (라인 27-41, 79-92): VWR 대기열에서 받은 토큰의 position을 디코딩하여 서버 큐 진입 시 우선순위로 전달

**리다이렉트 로직** (라인 117-127):
- `seatLayoutId`가 존재하면 -> `/events/[id]/seats`
- `seatLayoutId`가 null이면 -> `/events/[id]/book`

### 3.6 좌석 선택 예매 (`/events/[id]/seats`)

**파일**: `src/app/events/[id]/seats/page.tsx:1-312`

**기능**: 좌석 맵 시각화 (섹션별 열/좌석 그리드). 좌석 상태(available/reserved/locked) 표시. 좌석 1석 선택 후 예매.

**컴포넌트**: `SeatsPage` (라인 71)

**API 호출**:
- `seatsApi.byEvent(eventId)` - 좌석 목록 조회 (라인 97-98)
- `seatsApi.reserve({ eventId, seatIds })` - 좌석 예매 (라인 125-128)
- `useQueuePolling` - 큐 가드 (라인 83)

**상태 관리**: `useState` - `seats`, `selected`, `loading`, `booking`, `error`, `eventTitle`, `queueChecked` (라인 75-82)

**핵심 로직**:
- `buildSections(seats)` (라인 27-57): 좌석 배열을 섹션 -> 열 -> 좌석 번호 순으로 정렬
- 409 충돌 시 좌석 목록 자동 새로고침 (라인 144-146)

### 3.7 스탠딩 예매 (`/events/[id]/book`)

**파일**: `src/app/events/[id]/book/page.tsx:1-245`

**기능**: 좌석 레이아웃 없는 이벤트의 티켓 종류 선택 및 예매.

**API 호출**:
- `eventsApi.detail(eventId)` (라인 26-27)
- `reservationsApi.createTicketOnly(payload)` (라인 55-57)

**상태 관리**: `useState` - `event`, `tickets`, `selected`, `loading`, `booking`, `error` (라인 17-21)

**특이사항**: `idempotencyKey`로 `crypto.randomUUID()` 자동 생성 (`api-client.ts:166`) - 중복 예매 방지

### 3.8 결제 (`/payment/[reservationId]`)

**파일**: `src/app/payment/[reservationId]/page.tsx:1-219`

**기능**: 결제 수단(네이버페이/카카오페이/계좌이체/토스) 선택 및 결제. 만료 카운트다운 표시.

**API 호출**:
- `reservationsApi.byId(reservationId)` - 예매 정보 조회 (라인 43-44)
- `paymentsApi.prepare(payload)` - Toss 결제 준비 (라인 65-66)
- `paymentsApi.process(payload)` - 비 Toss 결제 처리 (라인 83-84)

**상태 관리**: `useState` + `useCountdown` (만료 타이머, 라인 53-55)

**Toss 결제 흐름** (라인 63-80):
1. `paymentsApi.prepare()` -> orderId, clientKey 수신
2. `loadTossPayments(clientKey)` 동적 임포트 (라인 72)
3. `tossPayments.requestPayment('카드', ...)` (라인 74-80)
4. 성공 시 `/payment/success?paymentKey=...&orderId=...&amount=...`로 리다이렉트
5. 실패 시 `/payment/fail?code=...&message=...`로 리다이렉트

### 3.9 결제 성공/실패 콜백

**성공**: `src/app/payment/success/page.tsx:1-122`
- Toss 콜백(paymentKey/orderId/amount 파라미터)이면 `paymentsApi.confirm()` 호출 (라인 27-28)
- React Query 캐시 무효화 (라인 22)
- `Suspense` 래핑으로 `useSearchParams` 정적 렌더링 에러 방지 (라인 111-121)

**실패**: `src/app/payment/fail/page.tsx:1-56`
- 에러 코드/메시지 쿼리 파라미터 표시 (라인 9-10)

### 3.10 내 예매 (`/my-reservations`)

**파일**: `src/app/my-reservations/page.tsx:1-186`

**기능**: 내 예매 목록 표시. 예매 취소, 양도 등록, 결제하기 액션. pending 상태의 만료 카운트다운.

**API 호출**:
- `useMyReservations()` -> `reservationsApi.mine()` (라인 120)
- `reservationsApi.cancel(id)` (라인 125)
- `transfersApi.create(id)` (라인 135)

**컴포넌트**: `ReservationRow` (라인 36-117) - 개별 예매 행 (카운트다운 포함)

### 3.11 예매 상세 (`/reservations/[id]`)

**파일**: `src/app/reservations/[id]/page.tsx:1-195`

**기능**: 예매 상세 정보(예매번호, 이벤트, 장소, 좌석, 금액). 결제하기/취소 액션.

**API 호출**: `reservationsApi.byId(params.id)` (라인 49-50)

**특이사항**: 백엔드의 `json_agg` 반환값 파싱 로직 (라인 76-91) - 배열, 문자열, `{type:"json", value:"[...]"}` 세 가지 형태 대응

### 3.12 아티스트 목록/상세

**아티스트 목록** (`/artists`): `src/app/artists/page.tsx:1-19`, `src/app/artists/page-client.tsx:1-90`
- SSR + CSR 하이브리드 패턴
- 아티스트 카드 그리드 (이미지, 이름, 설명, 공연 수, 멤버 수)

**아티스트 상세** (`/artists/[id]`): `src/app/artists/[id]/page.tsx:1-405`
- 멤버십 가입/현황 (티어: BRONZE/SILVER/GOLD/DIAMOND)
- 포인트 내역 테이블
- 등급별 혜택 비교 테이블 (라인 296-347)
- 아티스트 공연 일정 (선예매 스케줄 포함) (라인 350-402)
- API: `artistsApi.detail(id)`, `membershipsApi.myForArtist(id)`, `membershipsApi.subscribe(id)`

### 3.13 커뮤니티

**게시글 목록** (`/community`): `src/app/community/page.tsx:1-194`
- 아티스트별 카테고리 필터 (라인 68-92)
- 페이지네이션 지원 (라인 159-191)
- API: `communityApi.posts(params)`, `artistsApi.list()`

**게시글 상세** (`/community/[postId]`): `src/app/community/[postId]/page.tsx:1-241`
- 댓글 작성/삭제 기능
- 작성자 본인 수정/삭제 권한, 관리자 삭제 권한
- 댓글 작성 시 +10pt 적립 UI (라인 75-76)
- API: `communityApi.postDetail()`, `communityApi.comments()`, `communityApi.createComment()`, `communityApi.deleteComment()`

**글쓰기** (`/community/write`): `src/app/community/write/page.tsx:1-151`
- 아티스트 선택 필수 (라인 33-34)
- 작성 성공 시 +30pt 적립 표시 (라인 46, 59)

**글 수정** (`/community/[postId]/edit`): `src/app/community/[postId]/edit/page.tsx:1-130`
- 작성자 본인만 접근 가능 (라인 33-34)

### 3.14 공지사항 (News)

**목록/상세/생성/수정**: `src/app/news/page.tsx`, `src/app/news/[id]/page.tsx`, `src/app/news/create/page.tsx`, `src/app/news/[id]/edit/page.tsx`

### 3.15 양도 마켓

**양도 마켓** (`/transfers`): `src/app/transfers/page.tsx:1-227`
- 양도 등록 (confirmed 예매에서 선택) (라인 53-81)
- 아티스트별 필터 (라인 151-163)
- 판매자 본인 티켓은 "내 양도" 표시, 타인 티켓은 "구매하기" 버튼 (라인 206-217)

**내 양도 목록** (`/transfers/my`): `src/app/transfers/my/page.tsx:1-105`
- 양도 취소 기능 (라인 33-41)

**양도 구매 결제** (`/transfer-payment/[transferId]`): `src/app/transfer-payment/[transferId]/page.tsx:1-195`
- 결제 페이지와 동일한 결제 수단 선택 UI
- `paymentType: "transfer"` 파라미터로 구분

### 3.16 멤버십 결제 (`/membership-payment/[membershipId]`)

**파일**: `src/app/membership-payment/[membershipId]/page.tsx:1-206`

**특이사항**: URL 파라미터의 price 대신 서버에서 가격을 재조회 (라인 49-67) - 클라이언트 측 가격 조작 방지

### 3.17 검색 (`/search`)

**파일**: `src/app/search/page.tsx:1-98`

**기능**: 헤더 검색바에서 입력한 검색어로 이벤트 검색.

**API 호출**: `eventsApi.list({ q: query, page: 1, limit: 30 })` (라인 27)

### 3.18 관리자 통계 대시보드 (`/admin/statistics`)

**파일**: `src/app/admin/statistics/page.tsx:1-759`, `src/app/admin/statistics/StatisticsCharts.tsx:1-626`

**기능**: 12개 섹션의 종합 통계 대시보드.
1. 실시간 현황 (잠긴 좌석, 활성 결제, 활성 사용자, 최근 1시간 매출)
2. 개요 (총 사용자, 이벤트, 확정 예매, 매출)
3. 전환 퍼널 (완료/대기/취소 비율)
4. 시간대별 트래픽 (BarChart)
5. 일별 예매 추이 (LineChart)
6. 일별 매출 추이 (AreaChart)
7. 취소/환불 분석
8. 좌석 선호도 (PieChart + 가격대별 바)
9. 사용자 행동 (PieChart + 지출 분포)
10. 시스템 성능
11. 이벤트별 통계 테이블
12. 결제 수단 (PieChart + 테이블)

**API 호출** (병렬 12개): `statsApi.realtime()`, `statsApi.overview()`, `statsApi.conversion()`, `statsApi.hourlyTraffic()`, `statsApi.daily()`, `statsApi.revenue()`, `statsApi.cancellations()`, `statsApi.seatPreferences()`, `statsApi.userBehavior()`, `statsApi.performance()`, `statsApi.events()`, `statsApi.payments()` (라인 218-241)

**차트 컴포넌트**: `StatisticsCharts`는 `dynamic(() => import(...), { ssr: false })` (라인 21-28)로 SSR 제외하여 Recharts 서버 렌더링 문제 방지.

**실시간 갱신**: 30초 간격 `fetchRealtime()` (라인 244-247)

---

## 4. API 통신

### 4.1 api-client.ts 구현

**파일**: `src/lib/api-client.ts:1-298`

**Base URL 결정 로직** (`resolveBaseUrl()`, 라인 8-36):
1. `NEXT_PUBLIC_API_URL` 환경변수 확인 (라인 10-11)
2. SSR 환경이면 `http://localhost:3001` 폴백 (라인 15-16)
3. `window.__API_URL` 런타임 주입 확인 (K8s 환경) (라인 20-22)
4. localhost/사설IP이면 `http://{hostname}:3001` (라인 27-31)
5. 프로덕션: 빈 문자열 (same-origin, CloudFront/ALB 리버스 프록시) (라인 34-35)

**Axios 인스턴스** (라인 38-43):
```typescript
const http = axios.create({
  baseURL: `${resolveBaseUrl()}/api/v1`,
  headers: { "Content-Type": "application/json" },
  withCredentials: true,   // 쿠키 자동 전송
  timeout: 15000,          // 15초 타임아웃
});
```

### 4.2 게이트웨이 통신

- 모든 API 요청은 `/api/v1` 접두사 사용 (라인 39)
- 게이트웨이 서비스를 통해 마이크로서비스로 라우팅
- `withCredentials: true`로 HttpOnly 쿠키(JWT) 자동 전송 (라인 41)
- Queue Entry Token을 `x-queue-entry-token` 헤더로 전송 (라인 70-77)

### 4.3 VWR API 클라이언트

**파일**: `src/lib/api-client.ts:252-274`

VWR(Virtual Waiting Room) API는 별도 경로(`/vwr-api/`)를 사용하며, **Axios가 아닌 네이티브 `fetch`**를 사용한다.

```typescript
const VWR_BASE = '/vwr-api';  // 라인 252

export const vwrApi = {
  status: (eventId) => fetch(`${VWR_BASE}/vwr/status/${eventId}`).then(...),   // 라인 255-258
  assign: (eventId, userId) => fetch(`${VWR_BASE}/vwr/assign/${eventId}`, ...), // 라인 260-267
  check: (eventId, requestId, userId) => fetch(`${VWR_BASE}/vwr/check/...`),   // 라인 269-273
};
```

이 경로는 CloudFront에서 API Gateway(Lambda)로 라우팅되는 별도 오리진이다.

### 4.4 서버 컴포넌트 API

**파일**: `src/lib/server-api.ts:1-14`

서버 컴포넌트 전용 `fetch` 래퍼. `next: { revalidate: 60 }` (60초 ISR)을 기본값으로 설정한다 (라인 6-7).

홈/이벤트 상세/아티스트 목록의 SSR 데이터 페칭에서는 `server-api.ts`를 사용하지 않고 직접 `fetch`를 호출하며, `INTERNAL_API_URL` (기본값 `http://gateway-service:3001`) 환경변수를 사용한다 (`page.tsx:5`).

### 4.5 에러 처리 패턴

**401 Unauthorized - Silent Refresh** (라인 79-131):
1. 401 응답 수신 시 `/auth/refresh` 엔드포인트 호출 (라인 103)
2. 리프레시 진행 중 다른 요청은 큐에 대기 (라인 92-97)
3. 리프레시 성공 시 큐의 모든 요청 재시도 (라인 104-106)
4. 리프레시 실패 시 `clearAuth()` 호출 + 모든 큐 거부 (라인 107-112)
5. `/auth/login`, `/auth/register`, `/auth/refresh` 엔드포인트는 리프레시 시도 제외 (라인 88-89)

**429 Too Many Requests - 지수 백오프** (라인 118-127):
- 최대 2회 재시도 (라인 121)
- 지연: `Math.min(1000 * 2^retryCount, 4000)` (라인 123)

### 4.6 요청/응답 타입

**파일**: `src/lib/types.ts:1-278`

주요 타입 정의:
- `AuthUser` (라인 3-9): id, userId, email, name, role
- `EventSummary` / `EventDetail` (라인 11-40): snake_case + camelCase 이중 필드 지원
- `TicketType` (라인 42-50): 티켓 종류
- `Seat` (라인 52-61): 좌석 정보 (available/reserved/locked)
- `Reservation` (라인 94-108): 예매 정보
- `QueueStatus` (라인 120-136): 큐 상태 (queued, position, estimatedWait, entryToken)
- `VwrAssignResponse` / `VwrCheckResponse` / `VwrStatusResponse` (라인 138-162): VWR 관련
- `Artist` / `ArtistMembership` (라인 166-190): 아티스트 및 멤버십
- `MembershipBenefits` (라인 200-208): 등급별 혜택
- `TicketTransfer` (라인 210-229): 양도 정보
- `CommunityPost` / `CommunityComment` (라인 256-277): 커뮤니티
- `StatsOverview` / `DailyStats` / `EventStats` (라인 231-255): 통계

### 4.7 API 모듈 구성

`api-client.ts`에서 도메인별로 API 객체를 분리 export:

| API 모듈 | 라인 | 주요 메서드 |
|----------|------|------------|
| `authApi` | 133-141 | register, login, me, refresh, logout, google |
| `eventsApi` | 143-146 | list, detail |
| `queueApi` | 148-156 | check, status, heartbeat, leave |
| `reservationsApi` | 158-171 | createTicketOnly, mine, byId, cancel |
| `seatsApi` | 173-180 | byEvent, reserve |
| `paymentsApi` | 182-186 | prepare, confirm, process |
| `statsApi` | 188-203 | overview, daily, events 등 12개 |
| `communityApi` | 205-219 | posts, postDetail, createPost, updatePost, deletePost, comments, createComment, deleteComment |
| `newsApi` | 221-229 | list, byId, create, update, delete |
| `artistsApi` | 231-234 | list, detail |
| `membershipsApi` | 236-241 | subscribe, my, myForArtist, benefits |
| `transfersApi` | 243-249 | list, my, detail, create, cancel |
| `vwrApi` | 254-274 | status, assign, check |
| `adminApi` | 276-298 | dashboard, seatLayouts, events.*, tickets.*, reservations.* |

---

## 5. 상태 관리

### 5.1 React Query (TanStack Query)

**설정** (`src/app/providers.tsx:8-20`):
```typescript
new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 60 * 1000,      // 60초
      gcTime: 5 * 60 * 1000,     // 5분
      retry: 1,                   // 1회 재시도
      refetchOnWindowFocus: false, // 포커스 시 리패치 비활성
    },
  },
});
```

**React Query 훅**:
- `useEvents(params)` (`src/hooks/use-events.ts:6-14`) - queryKey: `["events", params]`
- `useEventDetail(id)` (`src/hooks/use-events.ts:16-29`) - queryKey: `["event", id]`
- `useMyReservations()` (`src/hooks/use-reservations.ts:6-14`) - queryKey: `["reservations", "mine"]`

### 5.2 Context Provider

**AuthContext** (`src/lib/auth-context.tsx:1-83`):
```typescript
interface AuthContextValue {
  user: AuthUser | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  refresh: () => void;    // 사용자 정보 재조회
  logout: () => Promise<void>;
}
```

- 컴포넌트 트리 최상위에서 `AuthProvider`가 `Providers` 내부에 배치 (`src/app/providers.tsx:24`)
- 마운트 시 `authApi.me()` 호출로 현재 세션 확인 (`auth-context.tsx:53-55`)
- 역할 정규화: `role.toLowerCase() === 'admin'` 처리 (`auth-context.tsx:39`)

### 5.3 인증 상태 흐름

1. 앱 로드 -> `AuthProvider.fetchUser()` -> `authApi.me()` (HttpOnly 쿠키 자동 전송) (`auth-context.tsx:29-30`)
2. 401 응답 -> `api-client.ts` 인터셉터가 `/auth/refresh` 호출 -> 새 쿠키 수신 -> 재시도 (라인 102-106)
3. 리프레시 실패 -> `clearAuth()` (localStorage 정리) + `user = null` (라인 108-109)

### 5.4 큐/VWR 폴링 상태

- `useQueuePolling` 훅이 `setTimeout` 기반 재귀 폴링으로 큐 상태 관리 (`src/hooks/use-queue-polling.ts:36-62`)
- `useVwrPolling` 훅이 VWR 대기열 상태 관리 (`src/hooks/use-vwr-polling.ts:44-219`)
- 각각 `mountedRef`, `pollTimerRef` 등 ref로 언마운트 시 정리

---

## 6. 인증 처리 (프론트엔드)

### 6.1 JWT 토큰 저장

JWT 토큰은 **HttpOnly 쿠키**로 저장된다. 프론트엔드 JavaScript에서 직접 토큰에 접근하지 않는다. Axios의 `withCredentials: true` (`api-client.ts:41`) 설정으로 쿠키가 자동 전송된다.

`localStorage`에는 사용자 정보를 저장하지 않는다. `clearAuth()` (`src/lib/storage.ts:8-11`)는 레거시 `user` 키만 제거한다.

### 6.2 토큰 전송 방식

- 모든 API 요청에 쿠키가 자동 첨부 (`withCredentials: true`)
- 별도의 `Authorization` 헤더 설정 없음
- VWR API(`/vwr-api/`)는 `fetch` 사용 - 쿠키 미전송 (userId를 파라미터로 직접 전달, `use-vwr-polling.ts:107`)

### 6.3 로그인 흐름

**이메일/비밀번호 로그인** (`src/app/login/page.tsx:19-38`):
1. 사용자 입력 -> `authApi.login({ email, password })` (라인 24)
2. 서버가 `Set-Cookie` 헤더로 JWT 쿠키 설정
3. `refreshAuth()` 호출 -> `authApi.me()` -> `setUser(...)` (라인 25)
4. `router.push("/")` (라인 26)

**Google OAuth 로그인** (`src/app/login/page.tsx:41-91`):
1. Google GSI 스크립트 동적 로드 (라인 44-71)
2. 사용자 Google 로그인 완료 -> `handleGoogleCallback(response)` (라인 78)
3. `authApi.google(response.credential)` (라인 82)
4. 서버가 Google ID 토큰 검증 -> JWT 발급 -> 쿠키 설정
5. `refreshAuth()` + `router.push("/")` (라인 83-84)

### 6.4 로그아웃 흐름

**SiteHeader** (`src/components/site-header.tsx:119-122`):
```typescript
onClick={async () => {
  await logout();       // authApi.logout() -> 쿠키 삭제 요청
  router.push("/login");
}}
```

`logout()` (`auth-context.tsx:57-64`):
1. `authApi.logout()` 호출 (서버에서 쿠키 무효화)
2. `setUser(null)` (라인 63)

### 6.5 토큰 리프레시 메커니즘

**Silent Refresh** (`api-client.ts:51-131`):

- `isRefreshing` 플래그로 동시 리프레시 방지 (라인 52)
- `failedQueue` 배열로 리프레시 중 실패한 요청 대기 (라인 53-57)
- 리프레시 흐름:
  1. 401 응답 감지 (라인 85)
  2. 이미 리프레시 중이면 큐에 추가 (라인 92-97)
  3. `http.post("/auth/refresh")` (라인 103)
  4. 성공: 큐의 모든 요청 재시도 (라인 104-106)
  5. 실패: `clearAuth()` + 큐 거부 (라인 107-112)

---

## 7. 주요 커스텀 훅

### 7.1 `useQueuePolling`

**파일**: `src/hooks/use-queue-polling.ts:1-73`

**목적**: 서버 기반 대기열의 상태를 주기적으로 폴링.

**구현**:
- 초기 폴링 간격: 3초 (`DEFAULT_POLL_SECONDS`, 라인 7)
- 서버 응답의 `nextPoll` 값으로 동적 조절 (라인 44-46)
- 폴링 간격 범위: 1초 ~ 60초 (`clampPoll`, 라인 11-13)
- `setTimeout` 재귀 방식 (라인 60)
- `mountedRef`로 언마운트 후 상태 업데이트 방지 (라인 19-26)

**Entry Token 저장** (라인 48-51): `data.entryToken`이 있으면 `urr-entry-token` 쿠키로 저장 (max-age 600초, SameSite=Strict). Lambda@Edge 검증용.

**반환값**: `{ status: QueueStatus | null, loading: boolean, error: string | null }` (라인 72)

### 7.2 `useVwrPolling`

**파일**: `src/hooks/use-vwr-polling.ts:1-220`

**목적**: AWS API Gateway 기반 가상 대기실(VWR) 상태 폴링.

**VWR 흐름**:
1. `init()` (라인 181-211): VWR 상태 확인 -> 비활성이면 바로 입장
2. localStorage에서 기존 세션 복원 시도 (라인 197-208)
3. `startAssign()` (라인 141-179): 새 대기열 순번 할당
4. `pollCheck()` (라인 102-139): 주기적 입장 여부 확인

**익명 사용자 ID 생성** (`getAnonUserId()`, 라인 9-30):
- 브라우저 fingerprint 해시(화면크기, 색상깊이, 타임존, 언어, 하드웨어 코어수)
- `anon-{hash}-{uuid8}` 형식으로 localStorage에 저장

**Phase 상태**: `checking` -> `waiting` -> `admitted` (또는 `inactive`, `error`) (라인 32)

**VWR 토큰** (라인 86-89): 입장 허가 시 `urr-vwr-token` 쿠키 저장 (max-age 600초).

**에러 복구** (라인 131-136): 404 응답 시 localStorage 정리 후 재할당

### 7.3 `useCountdown`

**파일**: `src/hooks/use-countdown.ts:1-110`

**목적**: 서버 시간 기반 정밀 카운트다운. 판매 시작/종료, 예매 만료 등에 사용.

**구현**:
- `useServerTime()` 훅으로 서버-클라이언트 시간 오프셋 보정 (라인 44)
- 1초 간격 `setInterval` (라인 86)
- 만료 시 `onExpire` 콜백 호출 (라인 81)
- 무한 루프 방지: 마운트 시 이미 만료된 경우 `onExpire` 미호출 (라인 66-74)

**포맷 함수**:
- `formatCountdown(t, showMonths)` (라인 93-104): "2개월 3일 5시간 30분 10초" 형식
- `formatCountdownShort(t)` (라인 106-110): "MM:SS" 형식

### 7.4 `useServerTime`

**파일**: `src/hooks/use-server-time.ts:1-57`

**목적**: 서버와 클라이언트 간 시간 오프셋 계산.

**구현** (라인 17-39):
1. `fetch('/api/time')` 호출 전후 시간 측정
2. RTT/2를 보정하여 오프셋 계산: `serverTime - (before + rtt/2)` (라인 30)
3. 결과를 모듈 레벨 캐시에 저장 (한 번만 호출) (라인 14, 18-19)

`getServerNow(offset)` (라인 55-57): `Date.now() + offset`으로 보정된 현재 시간 반환.

### 7.5 `useEvents` / `useEventDetail`

**파일**: `src/hooks/use-events.ts:1-29`

React Query 기반 이벤트 데이터 페칭 훅. 서버 응답의 다양한 필드명(`events`, `data`, `event`) 대응.

### 7.6 `useMyReservations`

**파일**: `src/hooks/use-reservations.ts:1-14`

React Query 기반 내 예매 데이터 페칭 훅.

---

## 8. UI/UX 패턴

### 8.1 디자인 시스템

**Tailwind CSS v4** 사용 (`apps/web/package.json:35`). shadcn/ui는 사용하지 않으며, 모든 컴포넌트를 직접 구현.

**CSS 변수 기반 테마** (`src/app/globals.css:3-14`):
```css
:root {
  --bg: #ffffff;
  --panel: #f8fafc;
  --line: #e2e8f0;
  --text: #1e293b;
  --muted: #475569;
  --accent: #0ea5e9;
  --accent-hover: #0284c7;
  --warning: #fbbf24;
  --danger: #ef4444;
  --success: #22c55e;
}
```

**폰트** (`src/app/layout.tsx:7-16`):
- 헤딩: Space Grotesk (`--font-heading`)
- 모노: IBM Plex Mono (`--font-mono`)

**색상 체계**: Tailwind의 `slate`, `sky`, `amber`, `red` 팔레트 중심. 프라이머리 액센트: `sky-500` (#0ea5e9).

### 8.2 반응형 디자인

**그리드 레이아웃**:
- 이벤트 카드: `grid gap-4 sm:grid-cols-2 lg:grid-cols-3` (`page-client.tsx:168`)
- 통계 카드: `grid gap-4 sm:grid-cols-2 lg:grid-cols-4` (`statistics/page.tsx:299`)
- 결제 수단: `grid grid-cols-2 gap-3` (`payment/page.tsx:171`)

**최대 너비 제약**:
- 메인 컨텐츠: `max-w-7xl` (`layout.tsx:35`)
- 폼 페이지: `max-w-sm`, `max-w-md`, `max-w-lg`, `max-w-2xl` (페이지별 상이)
- 관리자: `max-w-4xl`, `max-w-5xl`, `max-w-6xl`

**헤더 검색바**: `flex flex-1 max-w-md` - 화면 크기에 따라 유연하게 조절 (`site-header.tsx:32`)

### 8.3 로딩 상태

**스켈레톤 UI** (`src/app/loading.tsx:1-24`): `animate-pulse` 기반 회색 블록으로 이벤트 카드 레이아웃 미리보기.

**Spinner 컴포넌트** (`src/components/ui/Spinner.tsx:1-20`):
- 3가지 크기 (sm/md/lg)
- `role="status"` + `aria-label="Loading"` 접근성 속성 (라인 14-15)

**인라인 스피너**: 버튼 내부 `animate-spin rounded-full border-2 border-white border-t-transparent` 패턴 (예: `book/page.tsx:225`)

### 8.4 에러 상태

**글로벌 에러 바운더리** (`src/app/error.tsx:1-34`): "다시 시도" 버튼으로 `reset()` 호출.

**관리자 에러 바운더리** (`src/app/admin/error.tsx:1-27`): 관리자 전용 에러 메시지.

**인라인 에러**: `rounded-lg bg-red-50 border border-red-200 px-3 py-2 text-sm text-red-600` 패턴 (전체 앱 일관 적용).

### 8.5 접근성 고려사항

**Skip Navigation** (`src/app/layout.tsx:28-33`):
```html
<a href="#main-content" className="sr-only focus:not-sr-only ...">
  본문으로 건너뛰기
</a>
```

**시맨틱 마크업**:
- `<main id="main-content" role="main">` (`layout.tsx:35`)
- `<header>` (`site-header.tsx:23`)
- `<nav aria-label="메인 내비게이션">` (`site-header.tsx:50`)
- `<form role="search" aria-label="공연 및 아티스트 검색">` (`site-header.tsx:32`)
- `aria-label="검색어 입력"` (`site-header.tsx:35`)

**ARIA Live Region**: 큐 페이지의 `role="status" aria-live="polite" aria-label="대기열 상태"` (`queue/page.tsx:162`)

**Spinner 접근성**: `role="status" aria-label="Loading"` (`Spinner.tsx:15`)

**AuthGuard 로딩**: `role="status" aria-label="인증 확인 중"` (`auth-guard.tsx:30`)

**HTML lang 속성**: `<html lang="ko">` (`layout.tsx:25`)

---

## 9. 보안 (프론트엔드)

### 9.1 middleware.ts - CSP 헤더 및 Nonce

**파일**: `src/middleware.ts:1-37`

**CSP(Content Security Policy) 헤더** (라인 10-18):
```
default-src 'self'
script-src 'self' 'unsafe-inline' https://accounts.google.com https://apis.google.com
style-src 'self' 'unsafe-inline' 'nonce-{nonce}' https://accounts.google.com
img-src 'self' data: https:
connect-src 'self' http://localhost:* https://*.urr.guru https://accounts.google.com
frame-src https://accounts.google.com
frame-ancestors 'none'
```

**Nonce 생성** (라인 5): `Buffer.from(crypto.randomUUID()).toString("base64")`
- 매 요청마다 고유 nonce 생성
- `x-nonce` 헤더로 전달 (라인 21)
- `style-src`에 nonce 적용 (라인 13)

**참고**: `script-src`에 `'unsafe-inline'`이 포함된 이유는 Next.js RSC 페이로드가 빌드/프리렌더 시점에 생성되어 nonce를 부착할 수 없기 때문 (라인 7-8 주석)

### 9.2 추가 보안 헤더 (라인 24-28)

| 헤더 | 값 | 목적 |
|------|-----|------|
| `X-Frame-Options` | `DENY` | 클릭재킹 방지 |
| `X-Content-Type-Options` | `nosniff` | MIME 스니핑 방지 |
| `Referrer-Policy` | `strict-origin-when-cross-origin` | Referer 정보 제한 |
| `Permissions-Policy` | `camera=(), microphone=(), geolocation=(), payment=()` | 브라우저 기능 제한 |

### 9.3 미들웨어 매처 (라인 33-36)

정적 자산(`_next/static`, `_next/image`, `favicon.ico`)과 prefetch 요청은 미들웨어 제외.

### 9.4 XSS 방지

- React의 기본 이스케이핑 메커니즘으로 대부분의 XSS 방지
- 사용자 입력은 `innerHTML` 또는 `dangerouslySetInnerHTML` 없이 텍스트 노드로만 렌더링
- 커뮤니티/뉴스 콘텐츠: `whitespace-pre-wrap`으로 텍스트만 표시 (`community/[postId]/page.tsx:166`, `news/[id]/page.tsx:119`)
- CSP 헤더로 인라인 스크립트 실행 제한

### 9.5 민감 데이터 처리

- JWT 토큰: HttpOnly 쿠키에 저장 - JavaScript에서 접근 불가
- 비밀번호: 폼 state로만 관리, 전송 후 미저장
- 큐 Entry Token / VWR Token: 쿠키에 저장 (`SameSite=Strict`, HTTPS에서 `Secure`)
  - `use-queue-polling.ts:48-51`
  - `use-vwr-polling.ts:86-89`
- 멤버십 결제 가격: URL 파라미터가 아닌 서버 재조회 (`membership-payment/page.tsx:49-66`)
- Idempotency Key: `crypto.randomUUID()` 사용 (`api-client.ts:166, 178`)

---

## 10. 빌드 및 배포

### 10.1 Dockerfile 멀티스테이지 빌드

**파일**: `apps/web/Dockerfile:1-37`

**Stage 1: 빌드** (라인 1-16)
```dockerfile
FROM node:20-alpine AS builder
ARG NEXT_PUBLIC_API_URL=http://localhost:3001
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
COPY package*.json ./
RUN npm ci              # 의존성 설치 (lock 기반)
COPY . .
RUN npm run build       # Next.js 빌드
```

**Stage 2: 실행** (라인 18-37)
```dockerfile
FROM node:20-alpine AS runner
ENV NODE_ENV=production
RUN addgroup --system --gid 1001 nodejs && adduser --system --uid 1001 nextjs
COPY --from=builder --chown=nextjs:nodejs /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
USER nextjs
EXPOSE 3000
CMD ["node", "server.js"]
```

**특이사항**:
- `output: "standalone"` (`next.config.ts:8`) 활성화 -> `.next/standalone`에 최소 서버 번들 생성
- 비루트 사용자(`nextjs:nodejs`, UID 1001) 실행
- `NEXT_PUBLIC_API_URL`은 빌드 인자(ARG)로 주입 -> 빌드 시점에 JS 번들에 포함

### 10.2 next.config.ts 설정

**파일**: `apps/web/next.config.ts:1-19`

```typescript
const nextConfig: NextConfig = {
  turbopack: { root: path.resolve(__dirname) },
  output: "standalone",
  images: {
    remotePatterns: [
      { protocol: "https", hostname: "*.amazonaws.com" },
      { protocol: "https", hostname: "lh3.googleusercontent.com" },
    ],
  },
};
```

- **Turbopack**: 개발 서버에서 Turbopack 사용 (라인 5-7)
- **Standalone Output**: Docker 배포 최적화 (라인 8)
- **이미지 도메인**: AWS S3/CloudFront + Google 프로필 이미지 허용 (라인 9-13)

### 10.3 환경변수

**빌드 타임** (`NEXT_PUBLIC_` 접두사 -> JS 번들에 포함):
- `NEXT_PUBLIC_API_URL`: API 게이트웨이 URL (기본값: `http://localhost:3001`)
- `NEXT_PUBLIC_GOOGLE_CLIENT_ID`: Google OAuth 클라이언트 ID

**서버 전용** (서버 컴포넌트에서만 사용):
- `INTERNAL_API_URL`: 클러스터 내부 API URL (기본값: `http://gateway-service:3001`)

**런타임**:
- `NODE_ENV`: production/development
- `PORT`: 서버 포트 (기본값: 3000)
- `HOSTNAME`: 바인딩 주소 (Docker에서 `0.0.0.0`)

---

## 11. 평가

### 11.1 잘된 점

**1. SSR/CSR 하이브리드 패턴의 적절한 활용**
홈페이지(`page.tsx:3-14`), 이벤트 상세(`events/[id]/page.tsx:3-14`), 아티스트 목록(`artists/page.tsx:3-14`)에서 서버 컴포넌트가 초기 데이터를 페칭하고 클라이언트 컴포넌트에 `initialData`로 전달하는 패턴을 일관되게 사용. SEO와 초기 로딩 속도를 모두 확보.

**2. 보안 헤더 구현**
`middleware.ts`에서 CSP, X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy를 빠짐없이 설정 (라인 24-28). 요청마다 고유 nonce 생성 (라인 5).

**3. 토큰 리프레시 및 요청 큐잉**
`api-client.ts:51-131`의 silent refresh 구현이 완성도 높다. 동시 리프레시 방지(`isRefreshing`), 요청 큐잉(`failedQueue`), 429 지수 백오프까지 구현.

**4. 서버 시간 동기화**
`use-server-time.ts`에서 RTT 보정 기반 시간 오프셋 계산으로 카운트다운 정확도 확보. 모듈 레벨 캐싱으로 중복 요청 방지 (라인 14-19).

**5. VWR + Queue 이중 대기열 아키텍처**
CloudFront + API Gateway 기반 VWR(가상 대기실)과 서버 기반 큐를 병렬로 운영. VWR 비활성 시 자동 스킵 (`use-vwr-polling.ts:187-191`). VWR 포지션을 큐 우선순위로 브릿지 (`queue/page.tsx:79-92`).

**6. 접근성 기본 구현**
Skip navigation 링크 (`layout.tsx:28-33`), 시맨틱 HTML, ARIA 속성, Spinner role/aria-label, 한국어 lang 속성 등 기본 접근성 항목 구현.

**7. 스켈레톤 로딩 UI**
`loading.tsx`에서 `animate-pulse` 기반 스켈레톤으로 콘텐츠 레이아웃을 미리 표시하여 CLS(Cumulative Layout Shift) 최소화.

**8. Idempotency Key 자동 생성**
예매 및 좌석 예약 API에서 `crypto.randomUUID()` 기반 idempotency key 자동 부여 (`api-client.ts:166, 178`). 중복 요청으로 인한 이중 예매 방지.

**9. Docker 빌드 최적화**
`output: "standalone"` + 멀티스테이지 빌드 + 비루트 사용자 실행. 의존성 레이어 분리로 캐시 효율 극대화 (`Dockerfile:11-12`).

**10. 통계 차트 SSR 제외**
`StatisticsCharts`를 `dynamic(() => import(...), { ssr: false })` (`statistics/page.tsx:21-28`)로 로드하여 Recharts의 서버 렌더링 호환성 문제 회피.

### 11.2 미흡한 점

**1. 상태 배지 함수 중복**
`statusBadge()` 함수가 최소 6개 파일에 중복 정의:
- `page-client.tsx:20-34`
- `event-detail-client.tsx:11-26`
- `my-reservations/page.tsx:21-33`
- `admin/events/page.tsx:9-24`
- `admin/reservations/page.tsx:19-33`
- `reservations/[id]/page.tsx:28-39`

공통 컴포넌트(`StatusBadge.tsx`)가 존재하지만 실제 사용처에서는 사용되지 않는다.

**2. `label` 접근성 미비**
다수의 `<input>`, `<select>` 요소가 `<label>` 태그의 `htmlFor` 속성 없이 시각적 레이블만 제공. `<label className="block ...">제목</label>` 뒤에 `<input>`이 오지만 `htmlFor`/`id`로 연결되지 않음 (예: `admin/events/new/page.tsx:126-127`).

**3. not-found 페이지 영어 혼용**
`not-found.tsx`의 텍스트가 영어("Page not found", "Go home") (라인 8-19)인 반면, 나머지 앱은 한국어. 일관성 부재.

**4. `confirm()`/`alert()` 브라우저 네이티브 다이얼로그 사용**
예매 취소, 이벤트 삭제 등에서 `window.confirm()`/`window.alert()`를 직접 호출 (예: `my-reservations/page.tsx:123`, `admin/events/page.tsx:44`). 커스텀 모달로 교체 시 UX 향상 가능.

**5. 클라이언트 측 라우트 보호 한계**
`AuthGuard` (`auth-guard.tsx:13-44`)는 클라이언트에서 `useAuth()` 결과로 리다이렉트하지만, 미들웨어 레벨에서의 서버 측 보호가 없다. 인증 쿠키 유무를 미들웨어에서 확인하면 깜빡임 없는 보호가 가능하다.

**6. 다크 모드 미지원**
CSS 변수 기반 테마 시스템이 있으나 (`globals.css:3-14`) 라이트 모드만 정의. `prefers-color-scheme` 미디어 쿼리 미사용.

**7. 에러 바운더리 세분화 부족**
글로벌 에러 바운더리(`error.tsx`)와 관리자 에러 바운더리(`admin/error.tsx`)만 존재. 결제, 대기열 등 중요한 흐름에 전용 에러 바운더리가 없어 예외 발생 시 전체 페이지가 에러 상태로 전환될 수 있다.

**8. 키보드 내비게이션 제한**
좌석 선택 그리드(`seats/page.tsx:208-224`)에서 키보드 방향키 내비게이션이 구현되지 않음. 좌석 버튼에 `title` 속성은 있으나 (라인 218), 그리드 내 포커스 이동은 Tab 키에만 의존.

**9. 폼 유효성 검사 부족**
대부분의 폼에서 HTML5 `required` 속성만 사용. 비밀번호 강도 검사, 이메일 형식 실시간 검증, 전화번호 패턴 등 클라이언트 측 유효성 검사가 부재 (예: `register/page.tsx:51-89`).

**10. React Query 미적용 페이지 다수**
`useEvents`, `useMyReservations`는 React Query를 사용하지만, 관리자 페이지(`admin/events/page.tsx`), 커뮤니티(`community/page.tsx`), 뉴스(`news/page.tsx`) 등은 `useState` + `useEffect` 직접 패턴을 사용. 캐싱, 중복 요청 방지, 낙관적 업데이트 등의 이점을 활용하지 못함.

### 11.3 AWS 배포 시 보완 가능한 점

**1. CloudFront 기반 환경변수 런타임 주입**
현재 `NEXT_PUBLIC_API_URL`은 빌드 타임에 결정된다 (`Dockerfile:6-8`). `window.__API_URL` 런타임 주입 로직이 이미 준비되어 있으므로 (`api-client.ts:19-22`), CloudFront Function이나 Lambda@Edge에서 HTML에 `<script>window.__API_URL="..."`를 주입하면 환경별 빌드 불필요.

**2. S3 + CloudFront 정적 자산 최적화**
`next/image`의 `remotePatterns`에 AWS 도메인이 이미 설정되어 있으나 (`next.config.ts:11`), Image Optimization을 CloudFront + S3에서 처리하면 Next.js 서버 부하 감소 가능. CloudFront Image Handler Lambda를 통한 on-the-fly 리사이징 고려.

**3. ALB + 서버 측 인증 미들웨어**
현재 클라이언트 `AuthGuard`만 존재하므로, ALB 또는 CloudFront에서 인증 쿠키를 검증하여 비인증 사용자의 보호 경로 접근을 서버 레벨에서 차단. Lambda@Edge의 Entry Token 검증 패턴 (`api-client.ts:71-77`)을 확장하여 적용.

**4. WAF(Web Application Firewall) CSP 연계**
미들웨어의 CSP 헤더를 AWS WAF의 Custom Response Headers로 이전하면, Next.js 프로세스 부하 없이 엣지에서 보안 헤더 주입 가능. `connect-src`의 `http://localhost:*`를 프로덕션 배포 시 제거 필요 (`middleware.ts:15`).

**5. ElastiCache 기반 세션/큐 상태 공유**
현재 큐 폴링이 3초 간격 (`use-queue-polling.ts:7`)으로 설정되어 있어 서버 부하 유발 가능. ElastiCache(Redis)를 통한 WebSocket 또는 Server-Sent Events 업그레이드로 폴링 빈도 감소.

**6. CloudWatch RUM(Real User Monitoring)**
Core Web Vitals 측정을 위해 CloudWatch RUM 또는 `web-vitals` 라이브러리 연동. 현재 ESLint에 `eslint-config-next/core-web-vitals` (`eslint.config.mjs:6`)가 설정되어 있으나 실제 메트릭 수집은 미구현.

**7. Route 53 + CloudFront 헬스체크 기반 블루/그린 배포**
`output: "standalone"`과 Docker 기반 구조이므로 ECS Fargate + ALB 또는 App Runner에서 블루/그린 배포 용이. ArgoCD 설정이 이미 존재하므로 (`argocd/`) Kubernetes 배포도 가능.

**8. CSP의 `connect-src` 프로덕션 제한**
현재 `connect-src 'self' http://localhost:* https://*.urr.guru https://accounts.google.com` (`middleware.ts:15`)에서 `http://localhost:*`는 프로덕션에서 제거 필요. 환경변수로 분기하거나 배포 환경별 CSP 설정.

**9. VWR API 경로 동적 설정**
VWR API의 base path가 `'/vwr-api'` (`api-client.ts:252`)로 하드코딩되어 있다. CloudFront 오리진 라우팅에 의존하므로 환경변수로 설정 가능하게 하면 유연성 향상.

**10. Suspense 경계 확대**
`search/page.tsx:90-96`과 `payment/success/page.tsx:111-121`에서 `Suspense`를 사용하지만, 대부분의 클라이언트 페이지에서는 자체 로딩 상태 관리. React 18+의 Streaming SSR과 결합하여 서버 컴포넌트 내 `Suspense` 경계를 확대하면 TTFB와 FCP 개선 가능.
